
<!doctype html>
<html lang="en">
<head>
    <title>GET VIDEO</title>
    <meta charset="utf-8">
    <script src="js/jquery.js"></script>
    <!-- import CSS -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <!-- import Vue before Element -->
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <!-- import JavaScript -->
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
</head>
<body>
<div id="app" v-loading="loading">
    <el-page-header @back="goBack" content="采集照片">
    </el-page-header>
    <div style="margin-top: 20px;">
        <button @click="getMedia">开启摄像头</button>
        <button @click="takePhoto">拍照</button>
        <el-row style="margin-top: 20px;" :gutter="40">
            <el-col :span="12">
                <video id="video" width="500px" height="500px" autoplay="autoplay"></video>
            </el-col>
            <el-col :span="12">
                <canvas id="canvas" width="500px" height="500px"></canvas>
            </el-col>
        </el-row>
        <el-button type="primary" @click="uploadImg">上传图片</el-button>
    </div>
    <el-dialog :title="userName" :visible.sync="show">
        <img :src="imgBase64" style="width: 100%;"/>
    </el-dialog>
</div>


<script>
    new Vue({
        el: '#app',
        data: function() {
            return {
                userName: '',
                show: false,
                imgBase64: '',
                video: '',
                imgUrl: '',
                loading: false
            }
        },
        mounted(){
            if(localStorage.getItem("userId") === undefined || localStorage.getItem('userId') === null){
                window.location.pathname = '/login.html'
                return
            }
        },
        methods: {
            goBack(){
                window.location.pathname = 'index.html'
            },
            getMedia() {
                this.video = document.getElementById("video");
                let constraints = {
                    video: {width: 500, height: 500},
                    audio: true
                };
                let promise = navigator.mediaDevices.getUserMedia(constraints);
                promise.then((MediaStream)=> {
                    this.video.srcObject = MediaStream;
                    this.video.play();
                }).catch(function (PermissionDeniedError) {
                    console.log(PermissionDeniedError);
                })
            },
            takePhoto() {
                //获得Canvas对象
                let canvas = document.getElementById("canvas");
                let ctx = canvas.getContext('2d');
                ctx.drawImage(this.video, 0, 0, 500, 500);
                let url = canvas.toDataURL('image/png', 0.3)
                this.imgUrl = url
                console.log(this.imgUrl)
            },
            uploadImg(){
                if(this.imgUrl === ''){
                    alert('请先采集照片')
                    return
                }
                let data = {
                    imgBase64: this.imgUrl
                }
                this.loading = true
                $.ajax({
                    url: '/face',
                    data: data,
                    type: 'POST',
                    success: (res) => {
                        if(res === 'not exist'){
                            setTimeout(()=>{
                                this.loading = false
                                alert('该用户认证失败！')
                            },10000)
                        }else {
                            setTimeout(()=>{
                                this.loading = false
                                alert('识别成功，通过认证！')
                                this.imgBase64 = res.imgBase64
                                this.userName = '姓名：' + res.userName
                                this.show = true
                            },10000)
                        }
                    }
                })
            }
        }
    })
</script>

</body>
</html>
